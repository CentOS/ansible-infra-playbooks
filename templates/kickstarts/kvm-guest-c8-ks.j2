# Kickstart file automatically generated by Ansible.
# {{ ansible_managed }}

# Use network installation
url --url="{{ mirror_baseurl | default('http://mirror.centos.org/centos/8-stream') }}/BaseOS/{{ kvm_guest_arch }}/os/"
# Run the Setup Agent on first boot
firstboot --enable
#ignoredisk --only-use=sda
# Keyboard layouts
# old format: keyboard be-latin1
# new format:
keyboard --vckeymap=be-latin1 --xlayouts='be'
# System language
lang en_GB.UTF-8

{% if kvm_guest_ip is defined %}
network --device eth0 --bootproto static --ip {{ kvm_guest_ip }} --netmask {{ kvm_guest_netmask }} --gateway {{ kvm_guest_gateway }} --nameserver {{ kvm_guest_nameserver }} --hostname {{ inventory_hostname }} --activate
{% else %}
network --device eth0 --bootproto dhcp --hostname {{ inventory_hostname }}
{% endif %}

{% if kvm_guest_eth1 is defined %}
network --activate --device eth1 --bootproto static --ip {{ kvm_guest_eth1_ip }} --netmask {{ kvm_guest_eth1_netmask }} 
{% endif %}

# Root password
rootpw --iscrypted {{ kvm_guest_root_pass | password_hash('sha512') }}
# System services
services --enabled="chronyd"
# System timezone
timezone Etc/UTC --isUtc
# System bootloader configuration
bootloader --location=mbr --boot-drive=vda
# Partition clearing information
clearpart --all --initlabel 
# Disk partitioning information
# Adding first reqpart to automatically add /boot/efi or prepboot for aarch64, uefi, or IBM Power architectures
reqpart

{% if kvm_guest_arch == 'ppc64le' or kvm_guest_arch == 'ppc64' or kvm_guest_arch == 'power9' %}
part prepboot --asprimary --fstype=prepboot --size=10
{% endif %}
{% if kvm_guest_arch == 'aarch64' %}
part /boot/efi --fstype="vfat" --ondisk=vda --size=200
{% endif %}

part /boot --fstype="ext4" --ondisk=vda --size=1024

{%if kvm_guest_luks_encrypted %}
part pv.14 --fstype="lvmpv" --ondisk=vda --size=10000 --grow --encrypted --passphrase={{ kvm_guest_luks_passphrase }}
{% else %}
part pv.14 --fstype="lvmpv" --ondisk=vda --size=10000 --grow
{% endif %}

volgroup vg_{{ inventory_hostname_short }} --pesize=4096 pv.14
logvol /  --fstype="ext4" --size=10000 --grow --name=root --vgname=vg_{{ inventory_hostname_short }}
logvol /home  --fstype="ext4" --size={{ kvm_guest_disk_home_size | default(2048) }} --name=home --vgname=vg_{{ inventory_hostname_short }}
logvol swap  --fstype="swap" --size=2048 --name=swap --vgname=vg_{{ inventory_hostname_short }}

#Ensuring rebooting at the end
reboot

%packages
@^minimal-environment
@standard

%end

%addon com_redhat_kdump --disable
%end

%post

{% if centos_infra_env == "qa" %}
echo "PermitRootLogin yes" > /etc/ssh/sshd_config.d/01-permitrootlogin.conf
mkdir /root/.ssh
echo "{{ qa_jenkins_key | default('ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC+kByMD9fmCXAkFUHau3EtHimd3UZ3chQKaDGnss+WO2dKMYljUiXf/qmI6tXP1DFcS7BchDAZkrh3O9YA+ZGzk59a+3fBYB31Mjogh83qATRJOB/aa8Q3vdijfUJH/9OFc7pzdP17+hlGiCnQuW1YxGUa2Q/dOmfZdgWWuwLTq4xTxpAFihzkY6jiDZ6ZPg75KgH1qurYQxyggnbwmC3SI4EEStNkG1I2+YRBZpGgQBp/DIFvPxoMMuwuAv5bnNQlAhKi8Turx+fzWRMXXFgUTGD//wjvZffN4LZ0wXqIaXv3cKUEJ9ToDxFTcBC1NeefYhYouSQMKFAp36EM+0/okdsw+kokUBc83uJClZ4WjmyGlHn0RfcBMU8TyZhy1HAwNd+t1XPwgvgasoAojNINtD+kVA+UqZt3FuBhUD5Y0jm/7yjozDWiyczjhTKimH7Bm/mWdI/xOgTbV59yreaXo2L5Ghh6TgCBQ/i4d+NOAIPPiwGGGQvKn+9CFBrWckE=') }}" >> /root/.ssh/authorized_keys
chmod 700 /root/.ssh
chmod 600 /root/.ssh/* ; chcon -v -R -t ssh_home_t /root/.ssh**

# Disabling all repositories and pointing to QA
sed -i 's/enabled=1/enabled=0/g' /etc/yum.repos.d/*.repo

cat > /etc/yum.repos.d/CentOS-Stream-QA.repo << EOF
[baseos-staged]
name=CentOS Stream $releasever - BaseOS
baseurl={{ mirror_baseurl | default('http://mirror.centos.org/centos/8-stream') }}/BaseOS/{{ kvm_guest_arch }}/os/
gpgcheck=1
enabled=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial

[appstream-staged]
name=CentOS Stream $releasever - AppStream
baseurl={{ mirror_baseurl | default('http://mirror.centos.org/centos/8-stream') }}/AppStream/{{ kvm_guest_arch }}/os/
gpgcheck=1
enabled=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial

[powertools-staged]
name=CentOS Stream $releasever - PowerTools
baseurl={{ mirror_baseurl | default('http://mirror.centos.org/centos/8-stream') }}/PowerTools/{{ kvm_guest_arch }}/os/
gpgcheck=1
enabled=0
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial

EOF

{% else %}
# Ensuring that sshd is locked on reboot with key-based auth only
sed -i 's/PasswordAuthentication yes/PasswordAuthentication no/g' /etc/ssh/sshd_config 

# Using Ansible vars to automatically render template and add users 
{% for user in admins_list %}
# Adding user,ssh pub key and sudo right for {{ user.login_name }} 
/sbin/useradd {{ user.login_name}} -c "{{ user.full_name }}"
mkdir /home/{{ user.login_name }}/.ssh
{% for key in user.ssh_pub_key  %}
  echo "{{ key }}" >> /home/{{ user.login_name }}/.ssh/authorized_keys
{% endfor %}
chmod 700 /home/{{ user.login_name }}/.ssh
chmod 600 /home/{{ user.login_name }}/.ssh/* ; chcon -v -R -t ssh_home_t /home/{{ user.login_name }}/.ssh*
chown -R {{ user.login_name }}.{{ user.login_name}} /home/{{ user.login_name }}/
echo "{{ user.login_name }} ALL=(ALL) NOPASSWD: ALL" >/etc/sudoers.d/{{ user.login_name }}
{% endfor %}

{% endif %}

# tuning ext4
/sbin/tune2fs -m 0.5 /dev/mapper/vg_{{ inventory_hostname_short }}-root

%end


